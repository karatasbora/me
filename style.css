/**
 * RESUME CONTROLLER
 * Optimized for performance, safety, and maintainability.
 */

// --- 1. CONFIGURATION & CONSTANTS ---
const CONFIG = {
    labels: {
        about: { tr: "Hakkında", en: "About" },
        experience: { tr: "Deneyim", en: "Experience" },
        education: { tr: "Eğitim", en: "Education" },
        skills: { tr: "Teknik Yetkinlikler & Uzmanlıklar", en: "Technical Skills & Specializations" },
        languages: { tr: "Diller", en: "Languages" },
        print: { tr: "PDF", en: "PDF" },
        copied: { tr: "Kopyalandı!", en: "Copied!" }
    },
    seo: {
        tr: {
            title: "Bora Karataş - Özgeçmiş",
            desc: "İçerik Editörü ve Eğitimci. Yapay Zeka destekli, erişilebilir öğrenme deneyimleri tasarlıyor. Anadolu Üniversitesi Ar-Ge Birimi.",
            jobTitle: "İçerik Editörü"
        },
        en: {
            title: "Bora Karataş - Resume",
            desc: "Content Editor & Educator specializing in AI-Supported Learning Experiences. Instructional Design & EdTech Portfolio.",
            jobTitle: "Content Editor"
        }
    }
};

// Global state for cached data
const state = {
    schemaData: null // Cache for JSON-LD to avoid re-parsing
};

// --- 2. HTML GENERATORS (Pure Functions) ---

const createTagsHTML = (tags) => 
    tags ? tags.map(tag => `<span class="skill-tag">${tag}</span>`).join('') : '';

const createLanguageHTML = (languages, lang) => 
    languages.map(({ name, level }) => `
        <div class="lang-item">
            <span class="lang-title">${name[lang]}</span>
            <span class="lang-level">${level[lang]}</span>
        </div>
    `).join('');

const createBlockHTML = (item, lang) => {
    // Destructure specifically to handle both Job and School objects generically
    const title = item.role ? item.role[lang] : item.degree[lang];
    const subTitle = item.company ? item.company[lang] : item.school[lang];
    const tagsHTML = item.tags ? `<div class="tags-wrapper">${createTagsHTML(item.tags[lang])}</div>` : '';

    return `
    <div class="job-block">
        <div class="job-header">
            <span class="job-title">${title}</span>
            <span class="job-date">${item.date[lang]}</span>
        </div>
        <div class="job-subheader">
            <span class="company">${subTitle}</span>
            <span class="location">${item.location[lang]}</span>
        </div>
        <div class="job-content">
            <p>${item.desc[lang]}</p>
            ${tagsHTML}
        </div>
    </div>`;
};

// --- 3. DOM MANAGER ---
// We use a getter function or initialize this inside 'init' to prevent 'null' errors
// if script runs before DOM is ready.
const getElements = () => ({
    html: document.documentElement,
    metaDesc: document.querySelector('meta[name="description"]'),
    metaOgTitle: document.querySelector('meta[property="og:title"]'),
    metaOgDesc: document.querySelector('meta[property="og:description"]'),
    metaTwTitle: document.querySelector('meta[name="twitter:title"]'),
    metaTwDesc: document.querySelector('meta[name="twitter:description"]'),
    jsonLd: document.getElementById('json-ld'),
    
    // Text Elements
    name: document.getElementById('p-name'),
    title: document.getElementById('p-title'),
    location: document.getElementById('p-location'),
    email: document.getElementById('link-email'),
    linkedin: document.getElementById('link-linkedin'),
    
    // Sections
    aboutHead: document.getElementById('head-about'),
    aboutPara: document.getElementById('p-about'),
    expHead: document.getElementById('head-experience'),
    expList: document.getElementById('experience-list'),
    eduHead: document.getElementById('head-education'),
    eduList: document.getElementById('education-list'),
    skillsHead: document.getElementById('head-skills'),
    skillsList: document.getElementById('skills-list'),
    langsHead: document.getElementById('head-languages'),
    langsList: document.getElementById('languages-list'),
    
    // Controls
    btnPrintSpan: document.querySelector('#btn-print span'),
    btnPrint: document.getElementById('btn-print'),
    btnTr: document.getElementById('btn-tr'),
    btnEn: document.getElementById('btn-en'),
    btnTheme: document.getElementById('btn-theme')
});

// --- 4. CORE LOGIC ---

function updateSEO(lang, els) {
    const data = CONFIG.seo[lang];

    // 1. Basic Meta Tags
    document.title = data.title;
    if (els.metaDesc) els.metaDesc.setAttribute('content', data.desc);
    if (els.metaOgTitle) els.metaOgTitle.setAttribute('content', data.title);
    if (els.metaOgDesc) els.metaOgDesc.setAttribute('content', data.desc);
    if (els.metaTwTitle) els.metaTwTitle.setAttribute('content', data.title);
    if (els.metaTwDesc) els.metaTwDesc.setAttribute('content', data.desc);

    // 2. JSON-LD (Optimized: Parse once, update memory, write back)
    if (els.jsonLd) {
        try {
            // Initialize cache if empty
            if (!state.schemaData && els.jsonLd.textContent) {
                state.schemaData = JSON.parse(els.jsonLd.textContent);
            }
            
            if (state.schemaData) {
                state.schemaData.jobTitle = data.jobTitle;
                state.schemaData.description = data.desc;
                els.jsonLd.textContent = JSON.stringify(state.schemaData, null, 2);
            }
        } catch (e) {
            console.warn("JSON-LD update skipped due to parse error", e);
        }
    }
}

function renderResume(lang, els) {
    // Sanity Check: Ensure data exists
    if (typeof resumeData === 'undefined') {
        console.error("Critical Error: 'resumeData' is not defined.");
        return;
    }

    // 1. Update Document State
    els.html.lang = lang;
    updateSEO(lang, els);

    // 2. Profile & Contact (TextContent is safer than innerHTML)
    els.name.textContent = resumeData.profile.name;
    els.title.textContent = resumeData.profile.title[lang];
    els.location.textContent = resumeData.meta.location[lang];
    els.email.textContent = resumeData.meta.email;
    els.email.href = `mailto:${resumeData.meta.email}`;
    els.linkedin.textContent = resumeData.meta.linkedinLabel || "LinkedIn";
    els.linkedin.href = resumeData.meta.linkedin;

    // 3. Section Headers
    els.aboutHead.textContent = CONFIG.labels.about[lang];
    els.expHead.textContent = CONFIG.labels.experience[lang];
    els.eduHead.textContent = CONFIG.labels.education[lang];
    els.skillsHead.textContent = CONFIG.labels.skills[lang];
    els.langsHead.textContent = CONFIG.labels.languages[lang];
    if (els.btnPrintSpan) els.btnPrintSpan.textContent = CONFIG.labels.print[lang];

    // 4. Dynamic Content
    els.aboutPara.textContent = resumeData.profile.about[lang];
    
    // Helper to render lists efficiently
    const renderList = (element, data, generator) => {
        if (element && data) {
            element.innerHTML = data.map(item => generator(item, lang)).join('');
        }
    };

    renderList(els.expList, resumeData.experience, createBlockHTML);
    renderList(els.eduList, resumeData.education, createBlockHTML);
    if (els.skillsList) els.skillsList.innerHTML = createTagsHTML(resumeData.skills[lang]);
    renderList(els.langsList, resumeData.languages, (item) => `
        <div class="lang-item">
            <span class="lang-title">${item.name[lang]}</span>
            <span class="lang-level">${item.level[lang]}</span>
        </div>`
    );

    // 5. UI State & Animation
    els.btnTr.setAttribute('aria-pressed', lang === 'tr');
    els.btnEn.setAttribute('aria-pressed', lang === 'en');
    
    // Staggered Animation
    if (els.skillsList) {
        Array.from(els.skillsList.children).forEach((tag, index) => {
            tag.style.animationDelay = `${(index + 1) * 0.05}s`; 
        });
    }

    // Language Class hook
    document.body.classList.remove('lang-tr', 'lang-en');
    document.body.classList.add(`lang-${lang}`);
}

// --- 5. INITIALIZATION ---

document.addEventListener('DOMContentLoaded', () => {
    // 1. Safe DOM Element Retrieval
    const els = getElements();

    // 2. Determine Language
    const savedLang = localStorage.getItem('preferredLang');
    const browserLang = (navigator.language || navigator.userLanguage).startsWith('tr') ? 'tr' : 'en';
    const initialLang = savedLang || browserLang;

    // 3. Initial Render
    renderResume(initialLang, els);

    // 4. Event Listeners
    const switchLang = (lang) => {
        localStorage.setItem('preferredLang', lang);
        renderResume(lang, els);
    };

    els.btnTr?.addEventListener('click', () => switchLang('tr'));
    els.btnEn?.addEventListener('click', () => switchLang('en'));
    els.btnPrint?.addEventListener('click', () => window.print());

    // Theme Logic
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.setAttribute('data-theme', 'dark');
    }
    
    els.btnTheme?.addEventListener('click', () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        isDark ? document.body.removeAttribute('data-theme') : document.body.setAttribute('data-theme', 'dark');
    });

    // Copy to Clipboard Logic
    els.email?.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
            await navigator.clipboard.writeText(resumeData.meta.email);
            
            const currentLang = document.documentElement.lang;
            const feedbackText = CONFIG.labels.copied[currentLang] || "Copied!";
            
            els.email.setAttribute('data-copy-text', feedbackText);
            els.email.classList.add('copied');
            
            setTimeout(() => els.email.classList.remove('copied'), 2000);
        } catch (err) {
            console.error('Failed to copy email', err);
        }
    });
});
